{"is_source_file": true, "format": "TypeScript", "description": "This file is a middleware implementation for a Next.js application. It adds security headers, manages CORS policies, and applies rate limiting logic to routes under /api/. It is intended to run on the Edge runtime and enhances API route security and resilience.", "external_files": ["next/server", "@/lib/rateLimit"], "external_methods": ["buildRateLimitHeaders", "consume", "getClientIp"], "published": ["middleware", "config"], "classes": [], "methods": [{"name": "function shouldRateLimit(pathname: string): boolean { shouldRateLimit", "description": "Determines if a given request path should be rate limited, based on whether it starts with '/api'.", "scope": "", "scopeKind": ""}, {"name": "function applySecurityHeaders(response: NextResponse, req: NextRequest): NextResponse { applySecurityHeaders", "description": "Attaches a set of security and CORS headers to the response, adjusting according to route specifics.", "scope": "", "scopeKind": ""}, {"name": "export function middleware(req: NextRequest) { middleware", "scope": "", "scopeKind": "", "description": "unavailable"}], "calls": ["getClientIp", "consume", "buildRateLimitHeaders", "NextResponse.json", "NextResponse.next"], "search-terms": ["Next.js middleware", "rate limiting", "security headers", "/api route protection", "CORS handling"], "state": 2, "file_id": 61, "knowledge_revision": 129, "git_revision": "", "ctags": [{"_type": "tag", "name": "API_LIMIT", "path": "/home/kavia/workspace/code-generation/connecto-v1/src/middleware.ts", "pattern": "/^const API_LIMIT = 60; \\/\\/ 60 requests per minute per IP+path$/", "language": "TypeScript", "kind": "constant"}, {"_type": "tag", "name": "API_WINDOW_MS", "path": "/home/kavia/workspace/code-generation/connecto-v1/src/middleware.ts", "pattern": "/^const API_WINDOW_MS = 60_000; \\/\\/ 1 minute$/", "language": "TypeScript", "kind": "constant"}, {"_type": "tag", "name": "_000", "path": "/home/kavia/workspace/code-generation/connecto-v1/src/middleware.ts", "pattern": "/^const API_WINDOW_MS = 60_000; \\/\\/ 1 minute$/", "language": "TypeScript", "kind": "constant"}, {"_type": "tag", "name": "applySecurityHeaders", "path": "/home/kavia/workspace/code-generation/connecto-v1/src/middleware.ts", "pattern": "/^function applySecurityHeaders(response: NextResponse, req: NextRequest): NextResponse {$/", "language": "TypeScript", "kind": "function"}, {"_type": "tag", "name": "config", "path": "/home/kavia/workspace/code-generation/connecto-v1/src/middleware.ts", "pattern": "/^export const config = {$/", "language": "TypeScript", "kind": "constant"}, {"_type": "tag", "name": "csp", "path": "/home/kavia/workspace/code-generation/connecto-v1/src/middleware.ts", "pattern": "/^  const csp = [$/", "language": "TypeScript", "kind": "constant", "scope": "applySecurityHeaders", "scopeKind": "function"}, {"_type": "tag", "name": "headers", "path": "/home/kavia/workspace/code-generation/connecto-v1/src/middleware.ts", "pattern": "/^    const headers = new Headers(buildRateLimitHeaders(result));$/", "language": "TypeScript", "kind": "constant", "scope": "middleware", "scopeKind": "function"}, {"_type": "tag", "name": "ip", "path": "/home/kavia/workspace/code-generation/connecto-v1/src/middleware.ts", "pattern": "/^    const ip = getClientIp(req.headers);$/", "language": "TypeScript", "kind": "constant", "scope": "middleware", "scopeKind": "function"}, {"_type": "tag", "name": "key", "path": "/home/kavia/workspace/code-generation/connecto-v1/src/middleware.ts", "pattern": "/^    const key = `${ip}:${pathname}`;$/", "language": "TypeScript", "kind": "constant", "scope": "middleware", "scopeKind": "function"}, {"_type": "tag", "name": "middleware", "path": "/home/kavia/workspace/code-generation/connecto-v1/src/middleware.ts", "pattern": "/^export function middleware(req: NextRequest) {$/", "language": "TypeScript", "kind": "function"}, {"_type": "tag", "name": "origin", "path": "/home/kavia/workspace/code-generation/connecto-v1/src/middleware.ts", "pattern": "/^  const origin = req.headers.get(\"origin\") || \"\";$/", "language": "TypeScript", "kind": "constant", "scope": "applySecurityHeaders", "scopeKind": "function"}, {"_type": "tag", "name": "pathname", "path": "/home/kavia/workspace/code-generation/connecto-v1/src/middleware.ts", "pattern": "/^  const { pathname } = req.nextUrl;$/", "language": "TypeScript", "kind": "constant", "scope": "middleware", "scopeKind": "function"}, {"_type": "tag", "name": "preflight", "path": "/home/kavia/workspace/code-generation/connecto-v1/src/middleware.ts", "pattern": "/^    const preflight = NextResponse.json({}, { status: 204 });$/", "language": "TypeScript", "kind": "constant", "scope": "middleware", "scopeKind": "function"}, {"_type": "tag", "name": "res", "path": "/home/kavia/workspace/code-generation/connecto-v1/src/middleware.ts", "pattern": "/^      const res = NextResponse.json($/", "language": "TypeScript", "kind": "constant", "scope": "middleware", "scopeKind": "function"}, {"_type": "tag", "name": "res", "path": "/home/kavia/workspace/code-generation/connecto-v1/src/middleware.ts", "pattern": "/^    const res = NextResponse.next({ headers });$/", "language": "TypeScript", "kind": "constant", "scope": "middleware", "scopeKind": "function"}, {"_type": "tag", "name": "res", "path": "/home/kavia/workspace/code-generation/connecto-v1/src/middleware.ts", "pattern": "/^  const res = NextResponse.next();$/", "language": "TypeScript", "kind": "constant", "scope": "middleware", "scopeKind": "function"}, {"_type": "tag", "name": "result", "path": "/home/kavia/workspace/code-generation/connecto-v1/src/middleware.ts", "pattern": "/^    const result = consume(key, {$/", "language": "TypeScript", "kind": "constant", "scope": "middleware", "scopeKind": "function"}, {"_type": "tag", "name": "shouldRateLimit", "path": "/home/kavia/workspace/code-generation/connecto-v1/src/middleware.ts", "pattern": "/^function shouldRateLimit(pathname: string): boolean {$/", "language": "TypeScript", "kind": "function"}], "hash": "5d78503e864be759fc7278f823c41cd7", "format-version": 4, "code-base-name": "connecto-v1", "filename": "src/middleware.ts", "revision_history": [{"129": ""}]}